<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración - Sorteos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <!-- Botón de Cerrar Sesión -->
      <div class="d-flex justify-content-end">
        <form id="logoutForm">
          <button type="submit" class="btn btn-danger">Cerrar Sesión</button>
        </form>
      </div>

      <h1>Panel de Administración</h1>
      <h2>Sorteos Disponibles</h2>

      <!-- Botón para crear un sorteo -->
      <div class="mb-3">
        <a href="/admin-form" class="btn btn-primary">Crear sorteo</a>
      </div>

      <div id="sorteos">
        {% for sorteo in sorteos %}
        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">{{ sorteo.nombre }}</h5>
            <p class="card-text">{{ sorteo.descripcion }}</p>
            <p class="card-text">
              <strong>Precio del regalo:</strong> {{ sorteo.precio }}
            </p>
            <p class="card-text">
              <strong>Sobre el regalo:</strong> {{ sorteo.sobre_regalo }}
            </p>

            <h6>Participantes</h6>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                {% if sorteo.participantes %} {% for participante in
                sorteo.participantes %}
                <tr>
                  <td>{{ participante }}</td>
                  <td>
                    <form
                      class="eliminar-participante-form"
                      data-nombre-sorteo="{{ sorteo.nombre }}"
                      data-participante="{{ participante }}"
                    >
                      <button type="submit" class="btn btn-danger btn-sm">
                        Eliminar Participante
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %} {% else %}
                <tr>
                  <td colspan="2">No hay participantes aún.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>

            <!-- Botón para eliminar sorteo -->
            <form
              class="eliminar-sorteo-form"
              data-nombre="{{ sorteo.nombre }}"
            >
              <a
                href="/modificar-sorteo/{{ sorteo.nombre }}"
                class="btn btn-success mt-2"
              >
                Modificar Sorteo
              </a>
              <button type="submit" class="btn btn-danger">
                Eliminar Sorteo
              </button>
            </form>

            <!-- Si el sorteo ha comenzado, cambiar el texto del botón -->
            {% if not sorteo.inscripciones_abiertas %}
            <button
              class="btn btn-warning reiniciar-sorteo-btn"
              data-nombre-sorteo="{{ sorteo.nombre }}"
            >
              Reiniciar el sorteo
            </button>
            <button
              class="btn btn-info ver-resultados-btn"
              data-nombre-sorteo="{{ sorteo.nombre }}"
            >
              Ver resultados
            </button>
            {% else %}
            <button
              class="btn btn-warning empezar-sorteo-btn"
              data-nombre-sorteo="{{ sorteo.nombre }}"
            >
              EMPEZAR SORTEO
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- JavaScript para manejar la eliminación de participantes, sorteos y empezar sorteo -->
    <script>
      // Manejar el cierre de sesión
      document
        .getElementById("logoutForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const response = await fetch("/logout", {
            method: "GET",
          });
          if (response.ok) {
            window.location.href = "/"; // Redirigir a la página de inicio de sesión
          }
        });

      // Manejar la eliminación de sorteos
      document
        .querySelectorAll(".eliminar-sorteo-form")
        .forEach(function (form) {
          form.addEventListener("submit", async function (event) {
            event.preventDefault();
            const nombreSorteo = form.getAttribute("data-nombre");

            const formData = new FormData();
            formData.append("nombre_sorteo", nombreSorteo);

            const response = await fetch("/eliminar-sorteo", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              alert(result.message);
              window.location.reload(); // Recargar la página para ver los cambios
            } else {
              alert(result.error);
            }
          });
        });

      // Función para manejar el inicio o reinicio del sorteo
      function manejarSorteo(button, url) {
        button.addEventListener("click", async function (event) {
          event.preventDefault();
          const nombreSorteo = button.getAttribute("data-nombre-sorteo");

          const formData = new FormData();
          formData.append("nombre_sorteo", nombreSorteo);

          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message);
            window.location.reload(); // Recargar la página para ver los cambios
          } else {
            alert(result.error);
          }
        });
      }

      // Manejar el botón "EMPEZAR SORTEO"
      document
        .querySelectorAll(".empezar-sorteo-btn")
        .forEach(function (button) {
          manejarSorteo(button, "/empezar-sorteo");
        });

      // Manejar el botón "Volver a empezar el sorteo"
      document
        .querySelectorAll(".reiniciar-sorteo-btn")
        .forEach(function (button) {
          manejarSorteo(button, "/reiniciar-sorteo");
        });
      // Manejar el botón "Ver resultados"
      document
        .querySelectorAll(".ver-resultados-btn")
        .forEach(function (button) {
          button.addEventListener("click", async function (event) {
            event.preventDefault();
            const nombreSorteo = button.getAttribute("data-nombre-sorteo");

            const response = await fetch(`/resultados-sorteo/${nombreSorteo}`, {
              method: "GET",
            });

            const result = await response.json();

            if (response.ok) {
              // Mostrar los resultados en un alert
              const resultados = result.resultados.map((asignacion) =>
                asignacion.replace(/"/g, "")
              ); // Formatear las asignaciones
              alert(
                `Resultados del sorteo "${nombreSorteo}":\n` +
                  resultados.join("\n")
              );
            } else {
              alert(result.error);
            }
          });
        });
    </script>
  </body>
</html>
