<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Amigo Invisible</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif; }
  body { margin: 0; background: #f6f7f9; color: #111; }
  main { max-width: 740px; margin: 8vh auto; background: #fff; padding: 24px; border-radius: 12px;
         box-shadow: 0 6px 24px rgba(0,0,0,.08); }
  iframe {width: 100%; height: auto; aspect-ratio: 16 / 9; max-width: 100%; border: 0;}

  h1 { margin: 0 0 8px; font-size: 28px; }
  .muted { color:#666; margin:0 0 16px; }
  .card { padding:16px; border:1px solid #e6e8ec; border-radius:10px; background:#fafbfc }
  .big { font-size: 22px; }
  .err { color:#b00020; font-weight:600; }

  /* ===== a√±adido flujo cotilla ===== */
  p.Warning{background:#fff6e5;color:#7a4a00;border:1px solid #ffd48a;padding:10px 12px;border-radius:10px;font-weight:600}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid #e6e8ec;background:#ffffff;color:#111;cursor:pointer;user-select:none}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1 1 180px}
  input[type="text"],input[type="tel"],input[type="password"],input[type="number"]{padding:10px 12px;border-radius:10px;border:1px solid #dcdfe4;background:#fff;color:#111}
  label{font-size:14px;color:#666}
  .hr{height:1px;background:#e6e8ec;margin:16px 0}
  .msg{padding:12px;border-radius:10px;border:1px solid #e6e8ec;background:#f9fafb}
  a.inline{color:#2563eb;cursor:pointer}
  .center{display:flex;justify-content:center}
  .range-wrap{display:flex;align-items:center;gap:12px}
  input[type=range]{width:100%}
  .ok{color:#16a34a}
  .errText{color:#b00020}
  .hidden{display:none !important}
</style>
</head>
<body>
<main>
  <h1>üéÅ Amigo Invisible</h1>
  <p class="muted" id="group"></p>
  <div id="content" class="card big">Descifrando‚Ä¶</div>
  <p class="muted" style="margin-top:16px">Consejo: no compartas este enlace.</p>

  <!-- ===== a√±adido: flujo cotilla en la misma pantalla ===== -->
  <p class="Warning" id="minPrice">Precio m√≠nimo: 40‚Ç¨.</p>
  <button class="btn" id="btnVerResto">PULSA PARA VER A QUIEN LE HA TOCADO EL RESTO</button>
  <div id="flow" style="margin-top:16px"></div>
</main>
<script>
  // ===== descifrado original =====
  const b64uToBytes = (s) => {
    s = s.replace(/-/g, '+').replace(/_/g, '/');
    const pad = s.length % 4 ? 4 - (s.length % 4) : 0;
    s += '='.repeat(pad);
    const bin = atob(s);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
  };
  const bytesToStr = (b) => new TextDecoder().decode(b);

  (async () => {
    const hash = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
    const q = new URLSearchParams(hash);
    const ver = q.get('v') || '1';
    const ct = q.get('ct');
    const k  = q.get('k');

    const contentEl = document.getElementById('content');
    const groupEl = document.getElementById('group');

    if (ver !== '1' || !ct || !k) {
      contentEl.innerHTML = '<span class="err">Enlace inv√°lido.</span>';
    } else {
      try {
        const ctBytes = b64uToBytes(ct);
        const keyBytes = b64uToBytes(k);
        const iv = ctBytes.slice(0, 12);
        const data = ctBytes.slice(12);
        const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, 'AES-GCM', false, ['decrypt']);
        const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, cryptoKey, data);
        const payload = JSON.parse(bytesToStr(plainBuf));

        if (payload.group) groupEl.textContent = `Grupo: ${payload.group}`;
        const you = payload.for || 'Participante';
        const target = payload.target || '‚Äî';
        contentEl.innerHTML = `
          <div>Hola <strong>${you}</strong> üëã</div>
          <div>Te ha tocado: <strong>${target}</strong>.</div>
        `;
      } catch (e) {
        contentEl.innerHTML = '<span class="err">No se pudo descifrar el enlace (¬øda√±ado o caducado?).</span>';
      }
    }
  })();

  // ===== flujo cotilla (una sola pantalla, control JS) =====
  const flow = document.getElementById('flow');
  const btnVerResto = document.getElementById('btnVerResto');

  const state = { amount: 0, card:{ number:'', name:'', expiry:'', cvv:'' } };
  const html = (strings, ...vals) => strings.map((s,i)=> s + (vals[i] ?? '')).join('');
  function mount(node, content){ node.innerHTML = content; }

  function renderStep1(){
    mount(flow, html`
      <div class="msg">
        Veo que eres un poco cotilla. No pasa nada, te lo vamos a perdonar porque lo has hecho sin malas intenciones...
        <br>Pero si te pica la curiosidad puedes <a class="inline" id="aCurioso" href="#">pincharle aqu√≠</a>, aunque no est√° bien ...
      </div>
    `);
    document.getElementById('aCurioso').addEventListener('click', (e)=>{ e.preventDefault(); renderStep2(); });
  }

  function renderStep2(){
    mount(flow, html`
      <div class="msg">
        <strong>¬ø¬øOTRA VEZ??</strong> No me lo puedo creer. Qu√© verg√ºenza... ¬øC√≥mo se puede ser tan cotilla, por favor?
        <br>Vale, voy a dec√≠rtelo. Pero solo porque s√© que est√°s sufriendo por saberlo...
        <div class="hr"></div>
        <p>Para ello, tienes que poner cu√°nto te vas a gastar en el regalo.</p>
        <div class="range-wrap">
          <label for="rng">Presupuesto: <span id="rngVal">0‚Ç¨</span></label>
          <input id="rng" type="range" min="0" max="500" step="10" value="0" />
        </div>
        <div class="center" style="margin-top:10px">
          <button class="btn" id="btnVerReparto" disabled>VER REPARTO</button>
        </div>
      </div>
    `);
    const rng = document.getElementById('rng');
    const rngVal = document.getElementById('rngVal');
    const btn = document.getElementById('btnVerReparto');
    const update = ()=>{
      const v = Number(rng.value);
      state.amount = v;
      rngVal.textContent = v === 500 ? '+500‚Ç¨' : v + '‚Ç¨';
      btn.disabled = v !== 500; // Solo se activa al llegar a +500‚Ç¨
    };
    rng.addEventListener('input', update);
    update();
    btn.addEventListener('click', renderStep3);
  }

function renderStep3(){
  mount(flow, html`
    <div class="msg">
      <p>Adem√°s de cotilla, mentiroso. Creo que te est√°s colando. Pero bueno, ya para finalizar, te dejo que metas tu n√∫mero de tarjeta para poder redimirte de tus pecados.</p>
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>N√∫mero de tarjeta</label>
          <input id="ccNumber" type="tel" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" maxlength="23" />
        </div>
        <div class="field">
          <label>Nombre del titular</label>
          <input id="ccName" type="text" autocomplete="cc-name" placeholder="Nombre Apellidos" />
        </div>
        <div class="field">
          <label>Caducidad (MM/AA)</label>
          <input id="ccExpiry" type="text" inputmode="numeric" placeholder="MM/AA" maxlength="5" />
        </div>
        <div class="field">
          <label>CVV</label>
          <input id="ccCVV" type="password" inputmode="numeric" placeholder="123" maxlength="4" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="btnPay" disabled>Pagar para saberlo YA</button>
        <button class="btn" id="btnNoCard">No tengo tarjeta</button>
      </div>
      <p id="inlineErr" class="errText hidden">Se siente, mete tus datos</p>
    </div>
  `);

  const numberEl = document.getElementById('ccNumber');
  const nameEl   = document.getElementById('ccName');
  const expiryEl = document.getElementById('ccExpiry');
  const cvvEl    = document.getElementById('ccCVV');
  const btnPay   = document.getElementById('btnPay');
  const btnNo    = document.getElementById('btnNoCard');
  const inlineErr= document.getElementById('inlineErr');

  const digitsOnly = s => (s || '').replace(/\D+/g,'');
  const detectBrand = (numDigits) => {
    if (/^3[47]\d{13}$/.test(numDigits)) return 'amex';               // 15
    if (/^4\d{12}(\d{3}){0,2}$/.test(numDigits)) return 'visa';       // 13‚Äì19
    if (/^(5[1-5]\d{14}|2(2[2-9]\d{12}|[3-6]\d{13}|7[01]\d{12}|720\d{12}))$/.test(numDigits)) return 'mc'; // 16
    if (/^6(011\d{12}|5\d{14}|4[4-9]\d{13})$/.test(numDigits)) return 'discover'; // 16
    if (/^(50\d{10,17}|5[6-9]\d{10,17}|6\d{11,18})$/.test(numDigits)) return 'maestro'; // 12‚Äì19
    return 'unknown';
  };
  const luhn = (numDigits) => {
    const arr = numDigits.split('').reverse().map(x=>+x);
    if (arr.length < 13 || arr.length > 19) return false;
    let sum=0;
    for(let i=0;i<arr.length;i++){ let n=arr[i]; if(i%2===1){ n*=2; if(n>9)n-=9;} sum+=n; }
    return sum%10===0;
  };
  const validCard = (val) => {
    const d = digitsOnly(val);
    const brand = detectBrand(d);
    // Aceptamos unknown si pasa Luhn y longitud 13‚Äì19 (para no ser demasiado restrictivos)
    const lenOK = d.length >= 13 && d.length <= 19;
    return { ok: lenOK && luhn(d), brand, digits: d };
  };
  const validExpiry = (s) => {
    if(!/^\d{2}\/\d{2}$/.test(s)) return false;
    const [mm, aa] = s.split('/').map(Number);
    if (mm < 1 || mm > 12) return false;
    const year = 2000 + aa;
    const now = new Date();
    const curY = now.getFullYear(), curM = now.getMonth() + 1;
    // v√°lido si fecha es >= mes actual (no caducada)
    return (year > curY) || (year === curY && mm >= curM);
  };
  const validCVV = (s, brand) => {
    if (brand === 'amex') return /^\d{4}$/.test(s);
    return /^\d{3}$/.test(s);
  };
  const validName = (s) => s && s.trim().length >= 2;

  const formatNumber = (rawVal) => {
    const d = digitsOnly(rawVal).slice(0,19);
    const brand = detectBrand(d);
    if (brand === 'amex') {
      // 4-6-5
      return d.replace(/^(\d{0,4})(\d{0,6})(\d{0,5}).*$/, (_,a,b,c)=>[a,b,c].filter(Boolean).join(' '));
    }
    // bloques de 4
    return d.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
  };

  const update = () => {
    state.card.number = numberEl.value;
    state.card.name   = nameEl.value;
    state.card.expiry = expiryEl.value;
    state.card.cvv    = cvvEl.value;

    const card = validCard(state.card.number);
    // Ajustar placeholder/maxlength CVV por marca
    if (card.brand === 'amex') {
      cvvEl.maxLength = 4;
      cvvEl.placeholder = '1234';
    } else {
      cvvEl.maxLength = 3;
      cvvEl.placeholder = '123';
    }

    const ok = card.ok && validName(state.card.name) && validExpiry(state.card.expiry) && validCVV(state.card.cvv, card.brand);
    btnPay.disabled = !ok;
    inlineErr.classList.add('hidden');
  };

  numberEl.addEventListener('input', (e)=>{
    e.target.value = formatNumber(e.target.value);
    update();
  });
  expiryEl.addEventListener('input', (e)=>{
    let v = e.target.value.replace(/[^\d]/g,'').slice(0,4);
    if (v.length>=3) v = v.slice(0,2) + '/' + v.slice(2);
    e.target.value = v;
    update();
  });
  cvvEl.addEventListener('input', update);
  nameEl.addEventListener('input', update);

  btnNo.addEventListener('click', ()=>{ inlineErr.classList.remove('hidden'); });
  btnPay.addEventListener('click', renderStep4);

  // primera evaluaci√≥n
  update();
}


  function renderStep4(){
    mount(flow, html`
      <div class="msg">
        Mira, esto es para matarte. No te voy a cobrar na pero en fin, solo quiero que sepas que todo este empe√±o que has puesto para llegar hasta aqu√≠ sea el mismo para el cari√±o que le vayas a poner a tu regalo üòò
        <div class="center" style="margin-top:12px">
          <button class="btn" id="btnBack">Vale, me ha quedado claro üòî</button>
        </div>
      </div>
    `);
    document.getElementById('btnBack').addEventListener('click', renderStep5);
  }

  function renderStep5(){
    mount(flow, html`
      <div class="msg">
        <p>No pasa nada, te queremos igualmente.</p>
        <div class="row">
          <button class="btn" id="btnYes">Yo tambi√©n te quiero ü•∞</button>
          <button class="btn" id="btnNo">No te quiero nada ü§¨</button>
        </div>
        <div id="music" style="margin-top:12px"></div>
      </div>
    `);
    const music = document.getElementById('music');
    document.getElementById('btnYes').addEventListener('click', ()=>{
      music.innerHTML = `<iframe src="https://www.youtube.com/embed/25RHEayknOo?list=RD25RHEayknOo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
    });
    document.getElementById('btnNo').addEventListener('click', ()=>{
      music.innerHTML = `<iframe src="https://www.youtube.com/embed/ltmO9XQVdSg?list=RDltmO9XQVdSg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
    });
  }

  // arranque del flujo cotilla
  document.getElementById('btnVerResto').addEventListener('click', renderStep1);
</script>
</body>
</html>
